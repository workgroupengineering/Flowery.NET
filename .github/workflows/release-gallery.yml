name: Release Gallery

# MANUAL TRIGGER ONLY - Creates a Gallery-only release (no NuGet publish)
# Automatically determines version from library + increments gallery suffix
# Tags from main:  v1.8.0-gallery.1, v1.8.0-gallery.2, etc.
# Tags from alpha: v1.8.0-alpha-gallery.1, v1.8.0-alpha-gallery.2, etc.

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to release from'
        required: true
        type: choice
        options:
          - main
          - alpha
        default: main
      description:
        description: 'Optional: What changed in this release?'
        required: false
        type: string

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      lib_version: ${{ steps.version.outputs.lib_version }}
      gallery_suffix: ${{ steps.version.outputs.gallery_suffix }}
      tag: ${{ steps.version.outputs.tag }}
      display_version: ${{ steps.version.outputs.display_version }}
      branch: ${{ steps.version.outputs.branch }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0  # Need full history for tags

      - name: Determine version
        id: version
        run: |
          # Get branch from input
          BRANCH="${{ inputs.branch }}"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "Branch: $BRANCH"

          # Get library version from csproj
          LIB_VERSION=$(grep -oP '(?<=<Version>)[^<]+' Flowery.NET/Flowery.NET.csproj)
          echo "lib_version=$LIB_VERSION" >> $GITHUB_OUTPUT
          echo "Library version: $LIB_VERSION"

          # Build tag pattern based on branch
          if [ "$BRANCH" = "main" ]; then
            # Main branch: v1.8.0-gallery.N
            TAG_PREFIX="v${LIB_VERSION}-gallery."
            IS_PRERELEASE="false"
          else
            # Other branches (e.g., alpha): v1.8.0-alpha-gallery.N
            TAG_PREFIX="v${LIB_VERSION}-${BRANCH}-gallery."
            IS_PRERELEASE="true"
          fi
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

          # Get the highest existing suffix, default to 0 if none exist
          HIGHEST=$(git tag -l "${TAG_PREFIX}*" | sed "s/${TAG_PREFIX}//" | sort -n | tail -1)

          if [ -z "$HIGHEST" ]; then
            NEXT_SUFFIX=1
            echo "First gallery release for ${TAG_PREFIX%%.}"
          else
            NEXT_SUFFIX=$((HIGHEST + 1))
            echo "Existing gallery releases found, highest suffix: $HIGHEST"
          fi

          echo "gallery_suffix=$NEXT_SUFFIX" >> $GITHUB_OUTPUT

          TAG="${TAG_PREFIX}${NEXT_SUFFIX}"
          if [ "$BRANCH" = "main" ]; then
            DISPLAY="${LIB_VERSION}-gallery.${NEXT_SUFFIX}"
          else
            DISPLAY="${LIB_VERSION}-${BRANCH}-gallery.${NEXT_SUFFIX}"
          fi

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "display_version=$DISPLAY" >> $GITHUB_OUTPUT

          echo "Will create release: $TAG (prerelease: $IS_PRERELEASE)"

  build-gallery:
    needs: prepare
    uses: ./.github/workflows/_build-gallery.yml
    with:
      branch: ${{ inputs.branch }}
    permissions:
      contents: read

  publish:
    needs: [prepare, build-gallery]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./release-artifacts

      - name: Collect artifacts
        run: |
          mkdir -p ./final
          find ./release-artifacts -name "*.zip" -exec cp {} ./final/ \;
          find ./release-artifacts -name "*.tar.gz" -exec cp {} ./final/ \;
          echo "=== Release artifacts ==="
          ls -la ./final/

      - name: Create and push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ needs.prepare.outputs.tag }}
          git push origin ${{ needs.prepare.outputs.tag }}
          echo "Created tag: ${{ needs.prepare.outputs.tag }}"

      - name: Build release notes
        run: |
          {
            # Pre-release warning (if applicable)
            if [ "${{ needs.prepare.outputs.is_prerelease }}" = "true" ]; then
              echo "> **Pre-release** from \`${{ needs.prepare.outputs.branch }}\` branch - not for production use."
              echo ""
            fi

            echo "## Gallery Demo App Update"
            echo ""

            # Optional description (if provided)
            if [ -n "${{ inputs.description }}" ]; then
              echo "### What's Changed"
              echo ""
              echo "${{ inputs.description }}"
              echo ""
            fi

            echo "This is a **Gallery-only release** containing updates to the demo application."
            echo "The underlying Flowery.NET library version remains at **${{ needs.prepare.outputs.lib_version }}**."
            echo ""
            echo "### Downloads"
            echo ""
            echo "Self-contained executables - no .NET installation required!"
            echo ""
            echo "| Platform | Download |"
            echo "|----------|----------|"
            echo "| Windows x64 | \`Flowery.Gallery-Windows-x64.zip\` |"
            echo "| Linux x64 | \`Flowery.Gallery-Linux-x64.tar.gz\` |"
            echo "| macOS Intel | \`Flowery.Gallery-macOS-x64.tar.gz\` |"
            echo "| macOS Apple Silicon | \`Flowery.Gallery-macOS-arm64.tar.gz\` |"
            echo ""
            echo "---"
            echo ""
            echo "> For the NuGet package, see the latest library release: [v${{ needs.prepare.outputs.lib_version }}](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.prepare.outputs.lib_version }})"
          } > release_notes.md

          echo "=== Release Notes ==="
          cat release_notes.md

      - name: Load release notes
        id: release_body
        run: |
          {
            echo 'body<<EOF'
            cat release_notes.md
            echo ''
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare.outputs.tag }}
          name: "Gallery ${{ needs.prepare.outputs.display_version }}"
          files: ./final/*
          body: ${{ steps.release_body.outputs.body }}
          generate_release_notes: true
          prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Gallery Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** ${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ needs.prepare.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Library Version:** ${{ needs.prepare.outputs.lib_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Gallery Suffix:** ${{ needs.prepare.outputs.gallery_suffix }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-release:** ${{ needs.prepare.outputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release:** ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ needs.prepare.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
